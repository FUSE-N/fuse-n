<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="../static/img/boni_avatar.jpg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | Bonniface</title>
    <link rel="stylesheet" href="../static/css/styles.css">
    <link rel="stylesheet" href="../static/css/layout.css">
</head>

<body>
    {% set active_page = 'messages' %}
    {% include 'components/sidebar.html' %}

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="chat-layout">
        <!-- Threads List -->
        <div class="threads-sidebar" id="threadsSidebar">
            <div class="threads-header">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <h2 style="margin:0;">Messages</h2>
                    </div>
                </div>
                <input type="text" class="search-bar" placeholder="Search conversations...">
            </div>
            <div class="thread-list">
                <div class="thread-item active">
                    <div class="thread-avatar">
                        <ion-icon name="person" style="font-size: 1.5rem;"></ion-icon>
                    </div>
                    <div class="thread-info">
                        <div style="display: flex; justify-content: space-between;">
                            <div class="thread-name">Support Team</div>
                            <div class="thread-time">2m ago</div>
                        </div>
                        <div class="thread-last-msg">How can we help you today?</div>
                    </div>
                </div>
                <div class="thread-item">
                    <div class="thread-avatar" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">
                        J
                    </div>
                    <div class="thread-info">
                        <div style="display: flex; justify-content: space-between;">
                            <div class="thread-name">John Doe</div>
                            <div class="thread-time">1d ago</div>
                        </div>
                        <div class="thread-last-msg">Thanks for the update!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <main class="chat-area">
            <header class="chat-header">
                <div>
                    <h3 style="margin:0;">Support Team</h3>
                    <div style="font-size: 0.875rem; color: #4ade80;">Active now</div>
                </div>
                <div>
                    <button class="action-btn"><ion-icon name="ellipsis-vertical"></ion-icon></button>
                </div>
            </header>

            <div class="chat-messages" id="messageContainer">
                <div class="message received">
                    <div class="thread-avatar" style="width: 32px; height: 32px; align-self: flex-end;">
                        <ion-icon name="person"></ion-icon>
                    </div>
                    <div class="message-bubble">
                        Hello! Welcome to Bonniface support. How can I assist you with your project today?
                    </div>
                </div>

                <div class="message sent">
                    <div class="message-bubble">
                        Hi, I'm just exploring the new features.
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <!-- File Upload Button -->
                    <button class="action-btn" title="Attach File"
                        onclick="document.getElementById('fileInput').click()">
                        <ion-icon name="attach-outline"></ion-icon>
                    </button>
                    <input type="file" id="fileInput" hidden multiple onchange="handleFileSelect(this)">

                    <!-- Voice Recorder Button -->
                    <button class="action-btn" id="voiceBtn" title="Record Voice" onclick="toggleVoiceRecording()">
                        <ion-icon name="mic-outline"></ion-icon>
                    </button>

                    <input type="text" id="messageInput" placeholder="Type a message..."
                        onkeypress="handleKeyPress(event)">

                    <button class="send-btn" onclick="sendMessage()">
                        <ion-icon name="send"></ion-icon>
                    </button>
                </div>
                <div id="uploadStatus"
                    style="display:none; color: #60a5fa; font-size: 0.8rem; padding: 0.5rem 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        window.SUPABASE_URL = "{{ SUPABASE_URL }}";
        window.SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY }}";
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="../static/js/supabase_init.js"></script>
    <script defer type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script defer nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script defer src="../static/js/sidebar.js"></script>

    <script>
        let isRecording = false;

        function toggleVoiceRecording() {
            const btn = document.getElementById('voiceBtn');
            const icon = btn.querySelector('ion-icon');
            isRecording = !isRecording;

            if (isRecording) {
                btn.classList.add('recording');
                icon.setAttribute('name', 'stop-circle-outline');
                document.getElementById('messageInput').placeholder = "Recording voice...";
            } else {
                btn.classList.remove('recording');
                icon.setAttribute('name', 'mic-outline');
                document.getElementById('messageInput').placeholder = "Type a message...";
                alert("Voice recording captured! (Simulation)");
            }
        }

        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                const count = input.files.length;
                const status = document.getElementById('uploadStatus');
                status.textContent = `${count} file(s) attached: ${input.files[0].name}${count > 1 ? '...' : ''}`;
                status.style.display = 'block';
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        async function initMessages() {
            try {
                if (typeof window.supabaseClient === 'undefined') {
                    // Small delay to ensure deferred scripts are available
                    if (!window.supabaseRetryCount) window.supabaseRetryCount = 0;
                    if (window.supabaseRetryCount < 5) {
                        window.supabaseRetryCount++;
                        setTimeout(initMessages, 200);
                        return;
                    }
                }
                const session = await window.supabaseClient.checkSession();
                if (!session) {
                    window.location.href = '/login';
                    return;
                }
            } catch (error) {
                console.error('Messages init error:', error);
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const fileInput = document.getElementById('fileInput');
            const text = input.value.trim();
            const hasFile = fileInput.files.length > 0;

            if (text || hasFile) {
                const container = document.getElementById('messageContainer');

                let messageContent = text;
                if (hasFile) {
                    messageContent += `<div style="margin-top:0.5rem; display:flex; align-items:center; gap:0.5rem; background:rgba(0,0,0,0.2); padding:0.5rem; border-radius:0.5rem;">
                        <ion-icon name="document-text-outline"></ion-icon>
                        <span>${fileInput.files[0].name}</span>
                    </div>`;
                }

                const msgDiv = document.createElement('div');
                msgDiv.className = 'message sent';
                msgDiv.innerHTML = `<div class="message-bubble">${messageContent}</div>`;
                container.appendChild(msgDiv);

                // Reset inputs
                input.value = '';
                fileInput.value = '';
                document.getElementById('uploadStatus').style.display = 'none';

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
        }

        document.addEventListener('DOMContentLoaded', initMessages);
    </script>
</body>

</html>