
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | Fuse-IN</title>
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="../static/css/navbar.css">
  <link rel="stylesheet" href="../static/css/admin-styles.css">
  <style>
    :root {
      --sidebar-width: 280px;
      --primary-blue: #3b82f6;
      --bg-dark: #0f172a;
      --bg-card: rgba(255, 255, 255, 0.05);
      --border-color: rgba(255, 255, 255, 0.1);
      --online-color: #4ade80;
      --offline-color: #94a3b8;
    }

    body {
      background: var(--bg-dark);
      color: white;
      font-family: 'Inter', sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: rgba(15, 23, 42, 0.95);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .sidebar-header {
      padding: 2rem;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-nav {
      padding: 2rem 1rem;
      flex-grow: 1;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
      margin-bottom: 0.5rem;
      cursor: pointer;
    }

    .nav-item:hover,
    .nav-item.active {
      background: var(--bg-card);
      color: white;
    }

    .nav-item ion-icon {
      font-size: 1.25rem;
    }

    /* Main Content Area */
    .main-content {
      margin-left: var(--sidebar-width);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .view-section {
      display: none;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .view-section.active {
      display: block;
    }

    /* --- Chat / Messages Tab Styles --- */
    .chat-container {
      display: flex;
      height: 100%;
      background: var(--bg-dark);
    }

    .user-list-sidebar {
      width: 320px;
      border-right: 1px solid var(--border-color);
      background: rgba(15, 23, 42, 0.5);
      display: flex;
      flex-direction: column;
    }

    .chat-main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-dark);
    }

    .user-item {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-item:hover,
    .user-item.active {
      background: rgba(255, 255, 255, 0.05);
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #334155;
      position: relative;
      flex-shrink: 0;
    }
    .user-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .online-indicator {
      position: absolute;
      bottom: 2px;
      right: 2px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--bg-dark);
    }
    .online-indicator.online { background-color: var(--online-color); }
    .online-indicator.offline { background-color: var(--offline-color); }


    .chat-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .chat-header .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .chat-header .user-info .status {
        font-size: 0.875rem;
    }
     .chat-header .user-info .status.online { color: var(--online-color); }
     .chat-header .user-info .status.offline { color: var(--offline-color); }


    .chat-messages {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .message {
        max-width: 70%;
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }

    .message.received {
        align-self: flex-start;
    }

    .message.sent {
        align-self: flex-end;
        flex-direction: row-reverse;
    }

    .message-bubble {
        padding: 1rem;
        border-radius: 1rem;
        line-height: 1.5;
        position: relative;
        color: white;
    }

    .received .message-bubble {
        background: rgba(255, 255, 255, 0.1);
        border-top-left-radius: 0;
    }

    .sent .message-bubble {
        background: var(--primary-blue);
        border-top-right-radius: 0;
    }

    .chat-input-area {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        background: rgba(15, 23, 42, 0.95);
    }

    .input-wrapper {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 1rem;
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
    }

    .input-field {
        flex-grow: 1;
        background: transparent;
        border: none;
        padding: 0.75rem;
        color: white;
        font-family: inherit;
        font-size: 1rem;
    }

    .input-field:focus {
        outline: none;
    }

    .action-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 1.25rem;
    }
    .action-btn.send-btn { color: var(--primary-blue); }
  </style>
</head>

<body>
  <aside class="sidebar">
    <div class="sidebar-header">
         <a href="/index.html" class="logo-container" style="display:flex; align-items:center; gap:1rem; text-decoration:none; color:white;">
            <img src="../static/img/boni_avatar.jpg" alt="Logo" style="width: 32px; height: 32px; border-radius: 50%;">
            <span class="logo-text" style="font-weight: 700; font-size: 1.25rem;">Bonniface|Admin</span>
        </a>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item active" id="nav-overview" onclick="switchTab('overview', this)">
        <ion-icon name="grid-outline"></ion-icon>
        Overview
      </div>
      <div class="nav-item" id="nav-messages" onclick="switchTab('messages', this)">
        <ion-icon name="chatbubbles-outline"></ion-icon>
        Messages
        <span class="badge-count" style="background:#ef4444; color:white; font-size:0.75rem; padding: 2px 6px; border-radius:10px;">3</span>
      </div>
       <div class="nav-item" id="nav-files" onclick="alert('Files feature coming soon')">
        <ion-icon name="folder-outline"></ion-icon>
        Files
      </div>
      <div class="nav-item" id="nav-notifications" onclick="alert('Notifications feature coming soon')">
        <ion-icon name="notifications-outline"></ion-icon>
        Notifications
        <span class="badge-count" style="background:#ef4444; color:white; font-size:0.75rem; padding: 2px 6px; border-radius:10px;">5</span>
      </div>
      <div class="nav-item" id="nav-settings" onclick="alert('Settings feature coming soon')">
        <ion-icon name="settings-outline"></ion-icon>
        Settings
      </div>
    </nav>
    <div class="sidebar-footer">
        <a onclick="supabaseClient.signOut()" class="nav-item" style="color: #ef4444; font-weight:600;">
            <ion-icon name="log-out-outline"></ion-icon>
            Logout
        </a>
    </div>
  </aside>

  <main class="main-content">
    <!-- OVERVIEW TAB -->
    <div id="overview" class="view-section active">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">Dashboard Overview</h1>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div style="color: rgba(255, 255, 255, 0.6); margin-bottom: 1.5rem; font-weight: 500;">Total Projects</div>
          <div style="font-size: 2.5rem; font-weight: 700;">{{ stats.total_projects if stats else '-' }}</div>
        </div>
        <div class="stat-card">
          <div style="color: rgba(255, 255, 255, 0.6); margin-bottom: 1.5rem; font-weight: 500;">Total Messages</div>
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: #4ade80;"></div>
            <div style="font-size: 1.5rem; font-weight: 600; color: rgba(255, 255, 255, 0.4);">-</div>
          </div>
        </div>
        <div class="stat-card">
          <div style="color: rgba(255, 255, 255, 0.6); margin-bottom: 1.5rem; font-weight: 500;">Pending Requests</div>
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: #fbbf24;"></div>
            <div style="font-size: 1.5rem; font-weight: 600; color: rgba(255, 255, 255, 0.4);">-</div>
          </div>
        </div>
      </div>

      <div style="margin-bottom: 2rem;">
        <input type="text" placeholder="Search projects by name, title..." 
               style="width: 100%; max-width: 400px; padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); border-radius: 0.5rem; color: white;">
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Title</th>
              <th>Service</th>
              <th>Budget</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% if data %}
              {% for row in data %}
              <tr>
                <td>{{ row[0] }}</td>
                <td>{{ row[4] }}</td>
                <td>{{ row[5] }}</td>
                <td>{{ row[9] }}</td>
                <td><span style="padding: 0.25rem 0.75rem; border-radius: 1rem; background: rgba(59, 130, 246, 0.1); color: #60a5fa; font-size: 0.875rem;">Active</span></td>
                <td><button style="background: transparent; border: none; color: white; cursor: pointer;"><ion-icon name="ellipsis-vertical"></ion-icon></button></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" style="text-align: center; padding: 4rem; color: rgba(255, 255, 255, 0.4);">
                  Loading projects...
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- MESSAGES TAB -->
    <div id="messages" class="view-section" style="padding:0;">
      <div class="chat-container">
        <div class="user-list-sidebar">
          <div style="padding:1.5rem; border-bottom:1px solid var(--border-color);">
            <h3 style="margin:0;">Conversations</h3>
             <input type="text" id="userSearch" placeholder="Search users..." class="search-bar" style="width: 100%; margin-top: 1rem; box-sizing: border-box; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 0.5rem; color: white;">
          </div>
          <div id="user-list" style="overflow-y:auto; flex-grow:1;">
             <div style="text-align:center; padding: 2rem; opacity: 0.5;">Loading users...</div>
          </div>
        </div>
        <div id="chat-main" class="chat-main" style="position:relative;">
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; opacity: 0.5;">
                <ion-icon name="chatbubbles-outline" style="font-size: 5rem;"></ion-icon>
                <h2>Select a conversation</h2>
                <p>Choose a user from the list to start chatting.</p>
            </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../static/js/supabase_init.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  
  <script>
    class AdminChat {
        constructor() {
            this.supabase = window.supabase;
            this.currentUser = null;
            this.supportRoomId = null;
            this.allMessages = [];
            this.users = new Map();
            this.onlineUsers = new Set();
            this.selectedUserId = null;
            this.channel = null;

            this.init();
        }

        async init() {
            const { data: { session }, error } = await this.supabase.auth.getSession();
            if (error || !session) {
                window.location.href = 'login.html';
                return;
            }
            this.currentUser = session.user;

            // Simple check if user is admin (in a real app, use roles)
            if (!this.currentUser.email.includes('admin')) {
                 console.warn('Access denied. Not an admin.');
                 // window.location.href = 'login.html';
                 // return;
            }

            await this.getSupportRoom();
            if (this.supportRoomId) {
                await this.fetchUsersAndMessages();
                this.setupRealtime();
                this.renderUserList();
            }

            document.getElementById('userSearch').addEventListener('keyup', () => this.renderUserList());
        }

        async getSupportRoom() {
            const { data, error } = await this.supabase.from('chat_rooms').select('id').eq('name', 'Support Team').single();
            if (error) console.error('Error fetching support room:', error);
            else this.supportRoomId = data.id;
        }

        async fetchUsersAndMessages() {
            // Fetch all members of the support room
            const { data: members, error: memberError } = await this.supabase
                .from('room_members')
                .select('user_id, profiles(id, full_name, avatar_url)')
                .eq('room_id', this.supportRoomId);

            if (memberError) {
                console.error('Error fetching room members:', memberError);
                return;
            }

            members.forEach(m => {
                if (m.user_id !== this.currentUser.id && m.profiles) {
                    this.users.set(m.user_id, { ...m.profiles, online: false, unread: 0 });
                }
            });

            // Fetch all messages in the room
            const { data: messages, error: msgError } = await this.supabase
                .from('messages')
                .select('*')
                .eq('room_id', this.supportRoomId)
                .order('created_at', { ascending: true });

            if (msgError) console.error('Error fetching messages:', msgError);
            else this.allMessages = messages;
        }

        setupRealtime() {
            this.channel = this.supabase.channel(`admin-chat:${this.supportRoomId}`, {
                config: {
                    presence: { key: this.currentUser.id }
                }
            });

            this.channel
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                    this.allMessages.push(payload.new);
                    // If the new message belongs to the active chat, render it
                    if (payload.new.user_id === this.selectedUserId || payload.new.user_id === this.currentUser.id) {
                         this.renderMessagesForSelectedUser();
                    }
                    this.updateUnreadCount(payload.new.user_id);
                    this.renderUserList();
                })
                .on('presence', { event: 'sync' }, () => {
                    const presenceState = this.channel.presenceState();
                    this.onlineUsers.clear();
                    for (const id in presenceState) {
                        this.onlineUsers.add(presenceState[id][0].user_id);
                    }
                    this.renderUserList();
                    if(this.selectedUserId) this.renderChatHeader();
                })
                .subscribe();
        }

        renderUserList() {
            const userListEl = document.getElementById('user-list');
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            
            const sortedUsers = Array.from(this.users.values()).sort((a,b) => {
                 const aName = a.full_name || 'Unknown';
                 const bName = b.full_name || 'Unknown';
                 return aName.localeCompare(bName);
            });

            userListEl.innerHTML = '';
            
            for (const user of sortedUsers) {
                const isOnline = this.onlineUsers.has(user.id);
                user.online = isOnline;
                
                const name = user.full_name || 'Unknown User';
                if(searchTerm && !name.toLowerCase().includes(searchTerm)) continue;

                const item = document.createElement('div');
                item.className = 'user-item';
                if (user.id === this.selectedUserId) item.classList.add('active');
                
                item.innerHTML = `
                    <div class="user-avatar">
                        <img src="${user.avatar_url || '../static/img/boni_avatar.jpg'}" alt="${name}">
                        <div class="online-indicator ${isOnline ? 'online' : 'offline'}"></div>
                    </div>
                    <div style="flex-grow: 1; min-width:0;">
                        <div style="font-weight:600;">${name}</div>
                        <div style="font-size:0.8rem; opacity:0.6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Last message...</div>
                    </div>
                    ${user.unread > 0 ? `<span class="badge-count" style="background:#ef4444; color:white; font-size:0.75rem; padding: 2px 6px; border-radius:10px;">${user.unread}</span>` : ''}
                `;
                item.addEventListener('click', () => this.selectUser(user.id));
                userListEl.appendChild(item);
            }
        }
        
        selectUser(userId) {
            if (this.selectedUserId === userId) return;
            this.selectedUserId = userId;
            const user = this.users.get(userId);
            if(user) user.unread = 0;

            this.renderUserList(); // To update active state
            this.renderChatForUser(userId);
        }

        renderChatForUser(userId) {
            const chatMain = document.getElementById('chat-main');
            chatMain.innerHTML = `
                <div id="chat-header" class="chat-header"></div>
                <div id="chat-messages" class="chat-messages">Loading...</div>
                <div class="chat-input-area">
                    <div class="input-wrapper">
                        <input type="text" id="message-input" class="input-field" placeholder="Type a message to...">
                        <button id="send-btn" class="action-btn send-btn"><ion-icon name="send"></ion-icon></button>
                    </div>
                </div>
            `;
            this.renderChatHeader();
            this.renderMessagesForSelectedUser();

            document.getElementById('send-btn').addEventListener('click', () => this.sendMessage());
            document.getElementById('message-input').addEventListener('keypress', e => {
                if(e.key === 'Enter') this.sendMessage();
            });
        }
        
        renderChatHeader() {
            const user = this.users.get(this.selectedUserId);
            if(!user) return;
            const header = document.getElementById('chat-header');
            const isOnline = this.onlineUsers.has(user.id);

            header.innerHTML = `
                <div class="user-info">
                     <div class="user-avatar">
                        <img src="${user.avatar_url || '../static/img/boni_avatar.jpg'}" alt="${user.full_name}">
                        <div class="online-indicator ${isOnline ? 'online' : 'offline'}"></div>
                    </div>
                    <div>
                        <h3 style="margin:0;">${user.full_name || 'Unknown User'}</h3>
                        <div class="status ${isOnline ? 'online' : 'offline'}">${isOnline ? 'Online' : 'Offline'}</div>
                    </div>
                </div>
                <button class="action-btn"><ion-icon name="ellipsis-vertical"></ion-icon></button>
            `;
             document.getElementById('message-input').placeholder = `Message ${user.full_name || 'user'}`;
        }
        
        renderMessagesForSelectedUser() {
            const messagesContainer = document.getElementById('chat-messages');
            if(!messagesContainer) return;
            
            const filteredMessages = this.allMessages.filter(msg => 
                (msg.user_id === this.currentUser.id && msg.recipient_id === this.selectedUserId) || // Sent by admin to user
                (msg.user_id === this.selectedUserId && msg.recipient_id === this.currentUser.id) // Sent by user to admin
            );

            messagesContainer.innerHTML = filteredMessages.map(msg => {
                const senderClass = msg.user_id === this.currentUser.id ? 'sent' : 'received';
                const user = (senderClass === 'received') ? this.users.get(this.selectedUserId) : null;
                const avatarUrl = user ? (user.avatar_url || '../static/img/boni_avatar.jpg') : '../static/img/boni_avatar.jpg';

                return `
                    <div class="message ${senderClass}">
                         ${senderClass === 'received' ? `<div class="user-avatar" style="width:40px; height:40px;"><img src="${avatarUrl}" alt="avatar"></div>` : ''}
                        <div class="message-bubble">${this.escapeHTML(msg.content)}</div>
                    </div>
                `;
            }).join('') || '<div style="text-align:center; opacity:0.5;">No messages yet. Start the conversation!</div>';
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content || !this.selectedUserId) return;

            input.value = '';
            const message = {
                room_id: this.supportRoomId,
                user_id: this.currentUser.id,
                content: content,
                recipient_id: this.selectedUserId // Important for direct messaging within a group room
            };

            const { error } = await this.supabase.from('messages').insert(message);

            if (error) {
                console.error('Error sending message:', error);
                input.value = content; // Restore on failure
            }
        }
        
        updateUnreadCount(fromUserId) {
            if (fromUserId !== this.currentUser.id && fromUserId !== this.selectedUserId) {
                const user = this.users.get(fromUserId);
                if (user) {
                    user.unread = (user.unread || 0) + 1;
                }
            }
        }

        escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        window.adminChat = new AdminChat();
    });
    
    // Also handle tab switching
    function switchTab(tabId, navElement) {
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      navElement.classList.add('active');
    }

  </script>
</body>

</html>
